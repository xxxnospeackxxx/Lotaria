<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lucky 0‚Äì100 (Monthly)</title>
  <style>
    :root{
      --bg:#0b0f17;
      --card:#121a2a;
      --text:#e9eefc;
      --muted:#9fb0d0;
      --border:#22304a;
      --glow:#ffd34d;
      --glow2:#ff8a3d;
      --win:#4dffb5;
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, #152042 0%, var(--bg) 55%);
      color: var(--text);
      overflow-x:hidden;
    }
    .wrap{ max-width: 1100px; margin: 20px auto; padding: 16px; }
    h1{ margin:0 0 10px; font-size: 20px; font-weight: 800; letter-spacing: .2px; }
    .card{
      border:1px solid var(--border);
      background: rgba(18,26,42,.75);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; }
    label{ display:block; font-size: 13px; color: var(--muted); margin: 10px 0 6px; }
    input{
      width: 260px;
      max-width: 100%;
      box-sizing:border-box;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(10,14,25,.6);
      color: var(--text);
      outline:none;
    }
    input::placeholder{ color:#7f90b3; }
    button{
      appearance:none;
      border:1px solid var(--border);
      background: linear-gradient(180deg, #1a2744, #111a30);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 900;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:10px;
    }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .msg{
      margin-top: 10px;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(34,48,74,.9);
      background: rgba(10,14,25,.35);
      line-height: 1.4;
      min-height: 22px;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(56px, 1fr));
      gap: 10px;
      margin-top: 14px;
    }
    .cell{
      border:1px solid var(--border);
      background: rgba(18,26,42,.55);
      border-radius: 14px;
      height: 52px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      user-select:none;
      position:relative;
      overflow:hidden;
      transition: box-shadow .12s ease, border-color .12s ease, transform .12s ease;
    }
    .cell::after{
      content:"";
      position:absolute;
      inset:-30px;
      background: radial-gradient(circle at 30% 20%, rgba(255,211,77,.35), transparent 55%);
      opacity:0;
      transition: opacity .12s ease;
    }
    .cell.active{
      border-color: rgba(255,211,77,.85);
      box-shadow:
        0 0 0 2px rgba(255,211,77,.25),
        0 0 18px rgba(255,211,77,.35),
        0 0 28px rgba(255,138,61,.18);
      transform: translateY(-1px);
    }
    .cell.active::after{ opacity:1; }
    .cell.winner{
      border-color: rgba(77,255,181,.95);
      box-shadow:
        0 0 0 2px rgba(77,255,181,.22),
        0 0 20px rgba(77,255,181,.40);
    }
    .cell.winner::after{
      background: radial-gradient(circle at 30% 20%, rgba(77,255,181,.35), transparent 55%);
      opacity:1;
    }

    /* Confetti canvas */
    #confettiCanvas{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9999;
    }

    /* Overlay winner gigante */
    .overlay{
      position: fixed;
      inset: 0;
      z-index: 10000;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(5,8,16,.55);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    .hidden{ display:none; }

    .overlayCard{
      text-align:center;
      padding: 22px 26px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(18,26,42,.70);
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      transform-origin: center;
      animation: forwardBack 1.1s ease-in-out infinite;
    }
    .overlayTitle{
      font-size: clamp(28px, 4vw, 56px);
      font-weight: 1000;
      letter-spacing: .8px;
      text-transform: uppercase;
    }
    .overlayNum{
      margin-top: 10px;
      font-size: clamp(72px, 8vw, 120px);
      font-weight: 1100;
      color: var(--win);
      text-shadow: 0 0 22px rgba(77,255,181,.35);
    }
    @keyframes forwardBack{
      0%   { transform: translateX(-14px) scale(1.00); }
      50%  { transform: translateX(14px)  scale(1.10); }
      100% { transform: translateX(-14px) scale(1.00); }
    }

    .tiny{
      margin-left:auto;
      font-size: 12px;
      color: var(--muted);
      opacity:.85;
    }
  </style>
</head>

<body>
  <canvas id="confettiCanvas"></canvas>

  <!-- Overlay grande -->
  <div id="winnerOverlay" class="overlay hidden" aria-hidden="true">
    <div class="overlayCard">
      <div class="overlayTitle">Congratulations!</div>
      <div id="overlayNum" class="overlayNum">‚Äî</div>
    </div>
  </div>

  <div class="wrap">
    <h1>Lucky 0‚Äì100 (Monthly Draw)</h1>

    <div class="card">
      <div class="row">
        <div>
          <label>Telegram username</label>
          <input id="username" placeholder="@yourname" />
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <!-- sem "Start" -->
          <button id="playBtn" title="Play">
            <span aria-hidden="true">‚ñ∂</span> PLAY
          </button>
          <button id="resetBtn" title="Reset">RESET</button>
        </div>

        <div class="tiny" id="tokenHint"></div>
      </div>

      <div class="msg" id="msg">Enter your Telegram username and press PLAY.</div>

      <div id="grid" class="grid" aria-label="Number grid"></div>
    </div>
  </div>

  <!-- 1) Login/password -->
  <script>
    const PAGE_PASSWORD = "BigWinForMe";
    const p = prompt("üîí Protected page\n\nEnter password:");
    if (p !== PAGE_PASSWORD) {
      document.body.innerHTML =
        "<h1 style='text-align:center;margin-top:40px;font-family:system-ui;'>‚ùå Access denied</h1>";
      throw new Error("Access denied");
    }
  </script>

  <!-- 2) App -->
  <script>
    // ========= CONFIG =========
    const MIN = 0;
    const MAX = 100;

    // Token "criativo" no link: ?luck=luck0100 (n√£o mostra o n√∫mero)
    const LUCK_MAP = {
      "luck0100": 37
    };

    // ‚úÖ Dura√ß√£o fixa (sem mostrar tempo): 15 segundos
    const DURATION_MS = 15_000;
    const TICK_MS = 60;

    // ========= TOKEN =========
    const params = new URLSearchParams(window.location.search);
    const token = (params.get("luck") || "").trim();

    // Se token inv√°lido, usa default (37) mas avisa que o link est√° errado
    const WINNING_NUMBER =
      (token && Number.isInteger(LUCK_MAP[token]) ? LUCK_MAP[token] : 37);

    // ========= ELEMENTS =========
    const usernameEl = document.getElementById("username");
    const playBtn = document.getElementById("playBtn");
    const resetBtn = document.getElementById("resetBtn");
    const msgEl = document.getElementById("msg");
    const gridEl = document.getElementById("grid");
    const tokenHintEl = document.getElementById("tokenHint");

    const overlay = document.getElementById("winnerOverlay");
    const overlayNumEl = document.getElementById("overlayNum");

    const canvas = document.getElementById("confettiCanvas");
    const ctx = canvas.getContext("2d");

    // ========= STATE =========
    const cells = [];
    let running = false;
    let activeIndex = -1;
    let spinTimer = null;
    let stopTimeout = null;

    // ========= UI HELPERS =========
    function normalizeUsername(u){
      const s = (u || "").trim();
      if (!s) return "";
      return s.startsWith("@") ? s : ("@" + s);
    }

    function buildGrid(){
      gridEl.innerHTML = "";
      cells.length = 0;
      for (let n = MIN; n <= MAX; n++){
        const div = document.createElement("div");
        div.className = "cell";
        div.textContent = n;
        div.dataset.value = String(n);
        gridEl.appendChild(div);
        cells.push(div);
      }
    }

    function pickRandomIndex(exceptIndex){
      if (cells.length <= 1) return 0;
      let idx;
      do { idx = Math.floor(Math.random() * cells.length); }
      while (idx === exceptIndex);
      return idx;
    }

    function setActive(idx){
      if (activeIndex >= 0) cells[activeIndex].classList.remove("active");
      activeIndex = idx;
      cells[activeIndex].classList.add("active");
    }

    function setWinnerFixed(){
      const idx = WINNING_NUMBER - MIN;
      cells.forEach(c => c.classList.remove("active", "winner"));
      cells[idx].classList.add("winner");
      cells[idx].scrollIntoView({ behavior: "smooth", block: "center", inline: "center" });
    }

    function showOverlay(number){
      overlayNumEl.textContent = String(number);
      overlay.classList.remove("hidden");
      overlay.setAttribute("aria-hidden", "false");
    }

    function hideOverlay(){
      overlay.classList.add("hidden");
      overlay.setAttribute("aria-hidden", "true");
    }

    function clearAllVisual(){
      cells.forEach(c => c.classList.remove("active", "winner"));
      activeIndex = -1;
      hideOverlay();
      stopConfetti();
    }

    // ========= DRAW =========
    function start(){
      if (running) return;

      // exigir token v√°lido (para s√≥ funcionar com link certo)
      if (!token || !(token in LUCK_MAP)) {
        msgEl.textContent = "Invalid link token. Ask the organizer for the correct link.";
        return;
      }

      const user = normalizeUsername(usernameEl.value);
      if (!user){
        msgEl.textContent = "Type your Telegram username first (ex: @john123).";
        return;
      }

      running = true;
      playBtn.disabled = true;
      usernameEl.disabled = true;
      hideOverlay();

      cells.forEach(c => c.classList.remove("active", "winner"));
      msgEl.textContent = "Good luck‚Ä¶";

      // luz a rodar
      spinTimer = setInterval(() => {
        const idx = pickRandomIndex(activeIndex);
        setActive(idx);
      }, TICK_MS);

      // parar ao fim de 15s, sem mostrar countdown
      stopTimeout = setTimeout(() => stop(user), DURATION_MS);
    }

    function stop(user){
      if (!running) return;
      running = false;

      clearInterval(spinTimer);
      clearTimeout(stopTimeout);
      spinTimer = null;
      stopTimeout = null;

      // p√°ra SEMPRE no n√∫mero fixo
      setWinnerFixed();

      // overlay gigante + confetti
      showOverlay(WINNING_NUMBER);
      launchConfetti(260);

      msgEl.textContent = `Winner: ${WINNING_NUMBER} ‚Äî ${user}`;

      playBtn.disabled = false;
      usernameEl.disabled = false;

      // esconder overlay depois de uns segundos (opcional)
      setTimeout(() => hideOverlay(), 6500);
    }

    function resetAll(){
      if (running){
        running = false;
        clearInterval(spinTimer);
        clearTimeout(stopTimeout);
      }
      playBtn.disabled = false;
      usernameEl.disabled = false;
      msgEl.textContent = "Enter your Telegram username and press PLAY.";
      clearAllVisual();
    }

    // ========= CONFETTI =========
    let confetti = [];
    let confettiAnim = null;

    function resizeCanvas(){
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener("resize", resizeCanvas);

    function launchConfetti(count){
      resizeCanvas();
      confetti = [];
      for (let i = 0; i < count; i++){
        confetti.push({
          x: Math.random() * canvas.width,
          y: -20 - Math.random() * canvas.height * 0.3,
          r: 4 + Math.random() * 6,
          vx: -2 + Math.random() * 4,
          vy: 2 + Math.random() * 6,
          rot: Math.random() * Math.PI,
          vr: -0.2 + Math.random() * 0.4,
          c: `hsl(${Math.floor(Math.random()*360)}, 90%, 60%)`,
          life: 240 + Math.floor(Math.random()*140),
        });
      }
      if (confettiAnim) cancelAnimationFrame(confettiAnim);
      tickConfetti();
    }

    function tickConfetti(){
      ctx.clearRect(0,0,canvas.width,canvas.height);

      for (const p of confetti){
        p.x += p.vx;
        p.y += p.vy;
        p.rot += p.vr;
        p.vy += 0.03;
        p.life -= 1;

        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.rot);
        ctx.fillStyle = p.c;
        ctx.fillRect(-p.r, -p.r/2, p.r*2, p.r);
        ctx.restore();
      }

      confetti = confetti.filter(p => p.life > 0 && p.y < canvas.height + 50);

      if (confetti.length > 0){
        confettiAnim = requestAnimationFrame(tickConfetti);
      } else {
        stopConfetti();
      }
    }

    function stopConfetti(){
      if (confettiAnim) cancelAnimationFrame(confettiAnim);
      confettiAnim = null;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      confetti = [];
    }

    // ========= EVENTS =========
    playBtn.addEventListener("click", start);
    resetBtn.addEventListener("click", resetAll);
    usernameEl.addEventListener("keydown", (e) => { if (e.key === "Enter") start(); });

    // ========= INIT =========
    buildGrid();
    clearAllVisual();
    resizeCanvas();

    // hint pequeno (podes apagar se quiseres)
    tokenHintEl.textContent = token ? `token: ${token}` : "";
  </script>
</body>
</html>
